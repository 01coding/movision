<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhuhuibao.mybatis.tech.mapper.TechDataMapper" >
  <resultMap id="BaseResultMap" type="com.zhuhuibao.mybatis.tech.entity.TechData" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="createid" property="createid" jdbcType="BIGINT" />
    <result column="publishTime" property="publishTime" jdbcType="TIMESTAMP" />
    <result column="updateTime" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="fCategory" property="fCategory" jdbcType="INTEGER" />
    <result column="sCategory" property="sCategory" jdbcType="INTEGER" />
    <result column="tag" property="tag" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="views" property="views" jdbcType="BIGINT" />
    <result column="download" property="download" jdbcType="BIGINT" />
    <result column="attach" property="attach" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.zhuhuibao.mybatis.tech.entity.TechData" extends="BaseResultMap" >
    <result column="notes" property="notes" jdbcType="LONGVARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, createid, date_format(publishTime,'%Y-%m-%d') publishTime, date_format(updateTime,'%Y-%m-%d') updateTime, title, fCategory, sCategory, tag, type, status,
    views, download, attach
  </sql>
  <sql id="Blob_Column_List" >
    notes
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
    select
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from t_tech_data
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectMCTechDataDetail" resultType="java.util.Map" parameterType="java.lang.Long" >
    select t.id, t.createid, date_format(t.publishTime,'%Y-%m-%d') publishTime, date_format(t.updateTime,'%Y-%m-%d') updateTime,
    t.title, t.fCategory,tc.name fCategoryName,td.name sCategoryName, t.sCategory, t.tag, t.type, t.status,
    t.views, t.download, t.attach,t.notes from t_tech_data t
    left join t_dictionary_techDataCategory tc on tc.code = t.fCategory
    left join t_dictionary_techDataCategory td on td.code = t.sCategory
    where t.id = #{id}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.util.Map" >
    update t_tech_data
    <set >
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insertSelective" parameterType="com.zhuhuibao.mybatis.tech.entity.TechData" >
    insert into t_tech_data
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="createid != null" >
        createid,
      </if>
      publishTime,
      updateTime,
      <if test="title != null" >
        title,
      </if>
      <if test="fCategory != null" >
        fCategory,
      </if>
      <if test="sCategory != null" >
        sCategory,
      </if>
      <if test="tag != null" >
        tag,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="views != null" >
        views,
      </if>
      <if test="download != null" >
        download,
      </if>
      <if test="attach != null" >
        attach,
      </if>
      <if test="notes != null" >
        notes,
      </if>
      <if test="fileSize != null" >
        fileSize,
      </if>
      <if test="fileFormat != null" >
        fileFormat,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="createid != null" >
        #{createid,jdbcType=BIGINT},
      </if>
      now(),
      now(),
      <if test="title != null" >
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="fCategory != null" >
        #{fCategory,jdbcType=INTEGER},
      </if>
      <if test="sCategory != null" >
        #{sCategory,jdbcType=INTEGER},
      </if>
      <if test="tag != null" >
        #{tag,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="views != null" >
        #{views,jdbcType=BIGINT},
      </if>
      <if test="download != null" >
        #{download,jdbcType=BIGINT},
      </if>
      <if test="attach != null" >
        #{attach,jdbcType=VARCHAR},
      </if>
      <if test="notes != null" >
        #{notes,jdbcType=LONGVARCHAR},
      </if>
      <if test="fileSize != null" >
        #{fileSize},
      </if>
      <if test="fileFormat != null" >
        #{fileFormat},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zhuhuibao.mybatis.tech.entity.TechData" >
    update t_tech_data
    <set >
      <if test="createid != null" >
        createid = #{createid,jdbcType=BIGINT},
      </if>
      <if test="publishTime != null" >
        publishTime = #{publishTime,jdbcType=TIMESTAMP},
      </if>
      updateTime = now(),
      <if test="title != null" >
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="fCategory != null" >
        fCategory = #{fCategory,jdbcType=INTEGER},
      </if>
      <if test="sCategory != null" >
        sCategory = #{sCategory,jdbcType=INTEGER},
      </if>
      <if test="tag != null" >
        tag = #{tag,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="views != null" >
        views = #{views,jdbcType=BIGINT},
      </if>
      <if test="download != null" >
        download = #{download,jdbcType=BIGINT},
      </if>
      <if test="attach != null" >
        attach = #{attach,jdbcType=VARCHAR},
      </if>
      <if test="notes != null" >
        notes = #{notes,jdbcType=LONGVARCHAR},
      </if>
      <if test="reason != null">
        reason = #{reason}
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  <update id="updateTechDataViewsOrDL" parameterType="java.util.Map" >
    update t_tech_data
    <set>
      <if test="views != null" >
        views = views+1,
      </if>
      <if test="download != null" >
        download = download+1,
      </if>
    </set>
    where id = #{id}
  </update>
  <select id="findAllOMSTechDataPager" parameterType="java.util.Map" resultType="java.util.Map">
    select t.id, case when ur.mobile != '' or ur.mobile != null then ur.mobile when ur.email!= '' or ur.email != null then ur.email end as  username,
    date_format(t.publishTime,'%Y-%m-%d') publishTime, date_format(t.updateTime,'%Y-%m-%d') updateTime, t.title,
    tc.name fCategory, td.name sCategory, t.tag, t.type, t.status,t.price,
    t.views, t.download, t.attach,t.notes from t_tech_data t
    left join t_m_member ur on ur.id = t.createID
    left join t_dictionary_techDataCategory tc on tc.code = t.fCategory
    left join t_dictionary_techDataCategory td on td.code = t.sCategory
    where t.status != 4
    <if test="status != null and status != ''">
      and t.status = #{status}
    </if>
    <if test="title != null and title != ''">
      and t.title like concat('%',#{title},'%')
    </if>
    <if test="fCategory != null and fCategory != ''">
      and t.fCategory = #{fCategory}
    </if>
    <if test="sCategory != null">
      and t.sCategory = #{sCategory}
    </if>
    <if test="type != null">
      and t.type = #{type}
    </if>
  </select>

  <select id="findAllTechDataPager" parameterType="java.util.Map" resultType="com.zhuhuibao.mybatis.tech.entity.TechData">
    select t.id,case when ur.mobile != '' or ur.mobile != null then ur.mobile when ur.email!= '' or ur.email != null then ur.email end as  username,
    date_format(t.publishTime,'%Y-%m-%d') publishTime, date_format(t.updateTime,'%Y-%m-%d') updateTime, t.title,t.sCategory,
    td.name sCategoryName, t.type, t.status,t.price,t.notes from t_tech_data t
    left join t_m_member ur on ur.id = t.createID
    left join t_dictionary_techDataCategory tc on tc.code = t.fCategory
    left join t_dictionary_techDataCategory td on td.code = t.sCategory
    <where>
      <if test="title != null">
        and (t.title like concat('%',#{title},'%') or t.notes like concat('%',#{title},'%'))
      </if>
      <if test="status != null">
        and t.status = #{status}
      </if>
      <if test="fCategory != null and fCategory != ''">
        and t.fCategory = #{fCategory}
      </if>
      <if test="sCategory != null and sCategory != ''">
        and t.sCategory = #{sCategory}
      </if>
    </where>
    order by t.updateTime  desc
  </select>

  <select id="findScategory" parameterType="java.util.Map" resultType="java.util.Map">
    select t.sCategory,td.name from t_tech_data t
    left join t_dictionary_techDataCategory td on td.code = t.sCategory
    <where>
      <if test="title != null">
        and (t.title like concat('%',#{title},'%') or t.notes like concat('%',#{title},'%'))
      </if>
      <if test="status != null">
        and t.status = #{status}
      </if>
      <if test="fCategory != null and fCategory != ''">
        and t.fCategory = #{fCategory}
      </if>
      <if test="sCategory != null and sCategory != ''">
        and t.sCategory = #{sCategory}
      </if>
    </where>
    group by t.sCategory
  </select>

  <select id="previewTechDataDetail" parameterType="java.util.Map" resultType="java.util.Map">
    select t.id,case when ur.mobile != '' or ur.mobile != null then ur.mobile when ur.email!= '' or ur.email != null then ur.email end as  username,
    date_format(t.publishTime,'%Y-%m-%d') publishTime, date_format(t.updateTime,'%Y-%m-%d') updateTime, t.title,t.views,t.download,t.fileSize,t.fileFormat,
    t.type, t.notes from t_tech_data t
    left join t_m_member ur on ur.id = t.createID
    where t.id = #{id}
  </select>

  <select id="findViewsOrder" parameterType="java.util.Map" resultType="java.util.Map">
    select id,createid,title from t_tech_data
    <where>
      <if test="fCategory != null">
        and fCategory = #{fCategory}
      </if>
      <if test="status != null">
        and status = #{status}
      </if>
    </where>
    order by views desc limit #{count}
  </select>

  <select id="findDownloadOrder" parameterType="java.util.Map" resultType="java.util.Map">
    select id,createid,title from t_tech_data
    <where>
      <if test="fCategory != null">
        and fCategory = #{fCategory}
      </if>
      <if test="status != null">
        and status = #{status}
      </if>
    </where>
    order by download desc limit #{count}
  </select>

  <select id="findIndexTechData" parameterType="java.util.Map" resultType="java.util.Map">
    select id,title,sCategory,type from t_tech_data t
    <where>
      <if test="fCategory != null">
        and fCategory = #{fCategory}
      </if>
      <if test="count != null">
        and #{count} >= (select count(*) from t_tech_data t2 where t.sCategory = t2.sCategory and t.id > t2.id)
      </if>
      <if test="status != null">
        and status = #{status}
      </if>
    </where>
    order by sCategory,updateTime desc
  </select>

  <select id="findTechSiteInfo" parameterType="java.lang.Long" resultType="java.util.Map">
    select case when a.mobile != '' or a.mobile != null then a.mobile when a.email!= '' or a. email != null then a.email end as account,
    a.status,a.headShot,vip.vip_level,
    (select count(1) from t_tech_data t where t.status = 2 and t.createid = #{createId}) docNum,
    (select count(1) from t_tech_data t where t.status = 2) docTotal
    from t_m_member a left join t_vip_member_info vip on vip.member_id = a.id
    where a.id = #{createId}
  </select>
  <select id="findTechCount" resultType="java.util.Map">
    select count(1) docTotal from t_tech_data t where t.status = 2
  </select>
</mapper>