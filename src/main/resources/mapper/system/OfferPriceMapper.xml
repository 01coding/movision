<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhuhuibao.mybatis.memCenter.mapper.OfferPriceMapper" >
  <resultMap id="BaseResultMap" type="com.zhuhuibao.mybatis.memCenter.entity.OfferPrice" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="askid" property="askid" jdbcType="BIGINT" />
    <result column="createid" property="createid" jdbcType="BIGINT" />
    <result column="offerTime" property="offerTime" jdbcType="TIMESTAMP" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="billurl" property="billurl" jdbcType="VARCHAR" />
    <result column="isShow" property="isShow" jdbcType="BIT" />
    <result column="companyName" property="companyName" jdbcType="VARCHAR" />
    <result column="linkMan" property="linkMan" jdbcType="VARCHAR" />
    <result column="telephone" property="telephone" jdbcType="VARCHAR" />
    <result column="email" property="email" jdbcType="VARCHAR" />
  </resultMap>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select id, askid, createid,content,billurl,if(isShow=1,companyName,'') companyName, if(isShow=1,linkMan,'') linkMan,
    if(isShow=1,telephone,'') telephone, if(isShow=1,email,'') email,isShow
    from t_p_offer_price
    where id = #{id,jdbcType=BIGINT}
  </select>

  <select id="findAllOfferPriceByAskId" resultType="java.util.Map" parameterType="java.lang.Long">
    SELECT
      t.id,t.askid, t.createid ,t.offerTime,t.content,t.billurl,t.isShow,t.companyName,t.linkMan,t.telephone,t.email,
      CONCAT(pp.name, ct.name) address
    FROM
      t_p_offer_price t
      LEFT JOIN t_m_member m
        ON m.id = t.createid
      LEFT JOIN t_dictionary_province pp
        ON pp.code = m.province
      LEFT JOIN t_dictionary_city ct
        ON ct.code = m.city
    WHERE askid = #{askId,jdbcType=BIGINT}
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from t_p_offer_price
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insertSelective" parameterType="com.zhuhuibao.mybatis.memCenter.entity.OfferPrice" useGeneratedKeys="true" keyProperty="id">
    insert into t_p_offer_price
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="askid != null" >
        askid,
      </if>
      <if test="createid != null" >
        createid,
      </if>
        offerTime,
      <if test="content != null" >
        content,
      </if>
      <if test="billurl != null" >
        billurl,
      </if>
      <if test="isShow != null" >
        isShow,
      </if>
      <if test="companyName != null" >
        companyName,
      </if>
      <if test="linkMan != null" >
        linkMan,
      </if>
      <if test="telephone != null" >
        telephone,
      </if>
      <if test="email != null" >
        email,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="askid != null" >
        #{askid,jdbcType=BIGINT},
      </if>
      <if test="createid != null" >
        #{createid,jdbcType=BIGINT},
      </if>
        now(),
      <if test="content != null" >
        #{content,jdbcType=VARCHAR},
      </if>
       <if test="billurl != null" >
        #{billurl,jdbcType=VARCHAR},
      </if>
      <if test="isShow != null" >
        #{isShow,jdbcType=BIT},
      </if>
      <if test="companyName != null" >
        #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="linkMan != null" >
        #{linkMan,jdbcType=VARCHAR},
      </if>
      <if test="telephone != null" >
        #{telephone,jdbcType=VARCHAR},
      </if>
      <if test="email != null" >
        #{email,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zhuhuibao.mybatis.memCenter.entity.OfferPrice" >
    update t_p_offer_price
    <set >
      <if test="askid != null" >
        askid = #{askid,jdbcType=BIGINT},
      </if>
      <if test="createid != null" >
        createid = #{createid,jdbcType=BIGINT},
      </if>
      <if test="offerTime != null" >
        offerTime = #{offerTime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="isShow != null" >
        isShow = #{isShow,jdbcType=BIT},
      </if>
      <if test="companyName != null" >
        companyName = #{companyName,jdbcType=VARCHAR},
      </if>
      <if test="linkMan != null" >
        linkMan = #{linkMan,jdbcType=VARCHAR},
      </if>
      <if test="telephone != null" >
        telephone = #{telephone,jdbcType=VARCHAR},
      </if>
      <if test="email != null" >
        email = #{email,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="findAllAskingPriceInfo" parameterType="com.zhuhuibao.mybatis.memCenter.entity.AskPrice" resultType="com.zhuhuibao.mybatis.memCenter.entity.AskPriceSimpleBean">
  	select t.id,t.createid,t.title,if(t.type = 1,'公开询价','定向询价') typeName,
	concat(p.name,c.name) deliveryAddress,mm.enterpriseEmployeeParentId,
	date_format(t.endTime,'%Y-%m-%d') dateTime,
    (SELECT count(*) FROM t_p_offer_price where askid = t.id) as count
    from t_p_ask_price t
	left join t_dictionary_province p on t.provinceCode = p.code 
	left join t_dictionary_city c on t.cityCode = c.code
    left join t_m_member mm on mm.id = t.createid
	where date_format(now(),'%Y-%m-%d') &lt;= date_format(t.endTime,'%Y-%m-%d')
	<if test="title != null and title != ''">
		 and t.title like concat('%',#{title},'%')
	</if>
	<if test="type != null and type != ''">
		and t.type = #{type} 
	</if>
	<if test="createid != null and createid != ''">
        and case when t.supplierid is NULL then '1=1' when t.supplierid = '' then '1=1' else find_in_set(#{createid},t.supplierid) end
    </if>
    <if test="createid != null and createid != ''">
      and t.id not in (select askid from t_p_offer_price t where createid = #{createid})
    </if>
    <if test="createid != null and createid != ''">
      and t.createid != #{createid}
    </if>
    <if test="createid != null and createid != ''">
        and t.createid not in (select mc.enterpriseEmployeeParentId from t_m_member mc where id = #{createid})
    </if>
    <if test="createid != null and createid != ''">
        and t.createid not in (select id from t_m_member mc where mc.enterpriseEmployeeParentId = #{createid})
    </if>
    <if test="createid != null and createid != ''">
        and (case when mm.enterpriseEmployeeParentId != 0 then (mm.enterpriseEmployeeParentId not in (select mc.enterpriseEmployeeParentId from t_m_member mc where id = #{createid})) else '1=1' end )
    </if>
    <choose>
      <when test="publishTimeOrder != null and publishTimeOrder != ''">
        ORDER BY publishTime ${publishTimeOrder},dateTime desc
      </when>
      <when test="endTimeOrder != null and endTimeOrder != ''">
        ORDER BY endTime ${endTimeOrder},dateTime desc
      </when>
      <otherwise>
        order by dateTime desc
      </otherwise>
    </choose>
  </select>
  <select id="findAllOfferedPriceInfo" parameterType="java.util.Map" resultType="com.zhuhuibao.mybatis.memCenter.entity.AskPriceSimpleBean">
  	 select t.id,t.offerTime dateTime,concat(p.name,c.name) deliveryAddress,if(t.type = 1,'公开询价','定向询价') typeName,t.title,t.createid 
	 from (select op.id,op.createid,op.askid,date_format(op.offerTime,'%Y-%m-%d') offerTime,ap.provinceCode,ap.cityCode,ap.type,ap.title from t_p_offer_price op
	 left join t_p_ask_price ap on ap.id = op.askid
	 <where>
	 <if test="title != null and title != ''">
		 and ap.title like concat('%',#{title},'%')
	 </if>
	 <if test="createid != null and createid != ''">
	 	and op.createid = #{createid}
	 </if>
	 <if test="startDate != null and endDate != ''">
	    and date_format(op.offerTime,'%Y-%m-%d') &gt;= date_format(#{startDate},'%Y-%m-%d') and date_format(op.offerTime,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
	 </if>
	 </where>
	 ) t 
	 left join t_dictionary_province p on t.provinceCode = p.code 
	 left join t_dictionary_city c on t.cityCode = c.code
  </select>
  <select id="queryAllOfferPriceByAskID" parameterType="java.lang.Long" resultType="com.zhuhuibao.mybatis.memCenter.entity.AskPriceSimpleBean">
  	select n.id,n.createid,date_format(n.offerTime,'%Y-%m-%d') dateTime,concat(p.name,c.name) deliveryAddress,n.companyName from 
  	(select t.id,t.createid,t.offerTime,if(m.identify=3,concat(t.companyName,"(厂商)"),t.companyName) companyName,m.province,m.city from t_p_offer_price t left join t_m_member m on m.id = t.createid 
	where t.askid =#{id}) n 
	left join t_dictionary_province p on n.province = p.code 
	left join t_dictionary_city c on n.city = c.code
  </select>
  <select id="queryOfferPriceInfoByID" parameterType="java.lang.Long" resultType="com.zhuhuibao.mybatis.memCenter.entity.OfferAskPrice">
  	select t.id, t.askid, t.createid,t.content,t.billurl,if(t.isShow,t.companyName,'') companyName,
    if(t.isShow,t.linkMan,'') linkMan,if(t.isShow,t.telephone,'') telephone,if(t.isShow,t.email,'') email,
    t.isShow,a.title,if(a.type=1,'公开询价','定向询价') typeName,date_format(a.endTime,"%Y-%m-%d") endTime,a.period,
    if(a.isTax=1,'含税报价','不含税报价') taxName,concat(p.name,c.name,ar.name) address,ct.name categoryName,if(a.isShow=1,a.companyName,'') askCompanyName,
    if(a.isShow=1,a.linkMan,'') askLinkMan,a.isShow askisShow,if(a.isShow=1,a.telephone,'') askTelephone,
    if(a.isShow=1,a.email,'') askEmail,a.description description,a.productName,a.content askContent,a.billurl askBillUrl
    from t_p_offer_price t left join t_p_ask_price a on a.id = t.askid
    left join t_dictionary_province p on p.code = a.provinceCode
    left join t_dictionary_city c on c.code = a.cityCode
    left join t_dictionary_area ar on ar.code = a.areaCode
    left join t_dictionary_constant ct on ct.code = a.fcateid and ct.type = 26
    where t.id = #{id}
  </select>

  <select id="queryRecQuoteCount" resultType="java.lang.Integer" parameterType="java.util.Map">
    select count(1)  from t_p_offer_price o where o.askid in (select t.id from t_p_ask_price t where t.createId = #{createId})
  </select>

  <select id="queryQuoteCount" resultType="java.lang.Integer" parameterType="java.util.Map">
    select count(1) from t_p_ask_price t
      left join t_m_member mm on mm.id = t.createid
      where date_format(now(),'%Y-%m-%d') &lt;= date_format(t.endTime,'%Y-%m-%d')
      and case when t.supplierid is NULL then '1=1' when t.supplierid = '' then '1=1' else find_in_set(#{createId},t.supplierid) end
      and t.id not in (select askid from t_p_offer_price t where createid = #{createId})
      and t.createid != #{createId}
      and t.createid not in (select mc.enterpriseEmployeeParentId from t_m_member mc where id = #{createId})
      and t.createid not in (select id from t_m_member mc where mc.enterpriseEmployeeParentId = #{createId})
      and (case when mm.enterpriseEmployeeParentId != 0 then (mm.enterpriseEmployeeParentId not in (select mc.enterpriseEmployeeParentId from t_m_member mc where id = #{createId})) else '1=1' end )
  </select>
</mapper>